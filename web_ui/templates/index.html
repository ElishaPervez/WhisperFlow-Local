<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wispr Flow Clone</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1>Wispr Flow Clone <span class="gpu-badge" id="gpu-name">Detecting GPU...</span></h1>
            <div id="status-badge" class="status-badge">
                <div class="status-dot"></div>
                <span id="status-text">Ready</span>
            </div>
        </header>

        <!-- Live Status Card -->
        <div class="card">
            <div class="card-header">
                <h2>Live Transcription</h2>
                <button id="toggle-btn" class="btn btn-primary">Start Recording</button>
            </div>
            <div id="transcription-box" class="transcription-box">
                Waiting for speech...
            </div>
            <div style="margin-top: 1rem; display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-secondary);">
                <span id="last-action">Initialized</span>
            </div>
        </div>

        <div class="grid-2">
            <!-- Core Settings -->
            <div class="card">
                <div class="card-header">
                    <h2>Core Model</h2>
                </div>
                
                <div class="form-group">
                    <label>Optimization Preset</label>
                    <select id="preset-selector">
                        <option value="custom">Custom</option>
                        <option value="quality">Maximum Quality (large-v3)</option>
                        <option value="balanced">Balanced (distil-large-v3)</option>
                        <option value="speed">Maximum Speed (large-v3-turbo)</option>
                        <option value="low-vram">Low VRAM (distil-small.en)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Whisper Model</label>
                    <select id="model-size">
                        <!-- Populated by JS -->
                    </select>
                    <div class="vram-container">
                        <div class="vram-bar-bg">
                            <div id="est-vram-bar" class="vram-bar-fill"></div>
                        </div>
                        <div class="vram-text">
                            <span>Est. VRAM Usage</span>
                            <span id="est-vram-text">~0 GB</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Language</label>
                    <select id="language">
                        <option value="auto">Auto-Detect</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="it">Italian</option>
                        <option value="ja">Japanese</option>
                        <option value="zh">Chinese</option>
                        <option value="ko">Korean</option>
                    </select>
                </div>

                <label class="checkbox-wrapper">
                    <input type="checkbox" id="translate-check">
                    <span>Translate to English</span>
                </label>
            </div>

            <!-- Audio & AI -->
            <div class="card">
                <div class="card-header">
                    <h2>Audio & AI</h2>
                </div>

                <div class="form-group">
                    <label>Microphone</label>
                    <select id="device-selector">
                        <option value="-1">Default Device</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Global Hotkey</label>
                    <input type="text" id="hotkey-input" placeholder="e.g. ctrl+shift+space">
                </div>

                <hr style="border: 0; border-top: 1px solid var(--card-border); margin: 1.5rem 0;">

                <div class="form-group">
                    <label>Gemini API Key (Post-Processing)</label>
                    <input type="text" id="api-key" type="password" placeholder="Paste API Key here">
                </div>

                <div class="form-group">
                    <label>AI Model</label>
                    <select id="ai-model">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Fast)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (Smart)</option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Advanced Actions -->
        <div class="card">
            <div class="card-header">
                <h2>System Actions</h2>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="saveConfig()">Save All Settings</button>
                <button class="btn btn-secondary" onclick="freeVram()">Free VRAM Now</button>
                <button class="btn btn-secondary" onclick="setupDns()">Setup whisper.local URL</button>
                
                <div style="margin-left: auto; display: flex; gap: 1rem;">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="save-audio-check">
                        <span>Save Audio Recordings</span>
                    </label>
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="unload-check">
                        <span>Unload After Use</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State & Config ---
        let config = {};
        let systemInfo = {};
        let ws = null;

        // --- VRAM Estimates (FP16 approx) ---
        const vramEstimates = {
            "tiny": 0.1, "base": 0.2, "small": 0.5, "medium": 1.5,
            "large-v3": 3.1, "large-v3-turbo": 1.0,
            "distil-large-v3": 1.6, "distil-large-v2": 1.5,
            "distil-medium.en": 0.8, "distil-small.en": 0.4
        };

        // --- Initialization ---
        async function init() {
            await loadSystemInfo();
            await loadDevices();
            await loadConfig();
            connectWebsocket();
            setInterval(pollStatus, 500); // Fallback polling
            
            // Event Listeners
            document.getElementById('toggle-btn').onclick = toggleRecording;
            document.getElementById('model-size').onchange = updateVramEstimate;
            document.getElementById('preset-selector').onchange = applyPreset;
        }

        // --- API Calls ---
        async function loadSystemInfo() {
            const res = await fetch('/api/system-info');
            systemInfo = await res.json();
            
            document.getElementById('gpu-name').textContent = systemInfo.gpu || systemInfo.cpu;
            
            // Populate models
            const modelSelect = document.getElementById('model-size');
            modelSelect.innerHTML = '';
            systemInfo.models_available.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                modelSelect.appendChild(opt);
            });
        }

        async function loadDevices() {
            const res = await fetch('/api/devices');
            const devices = await res.json();
            const sel = document.getElementById('device-selector');
            sel.innerHTML = '<option value="-1">Default Device</option>';
            devices.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.index;
                opt.textContent = d.name;
                sel.appendChild(opt);
            });
        }

        async function loadConfig() {
            const res = await fetch('/api/config');
            config = await res.json();
            
            // Apply to UI
            document.getElementById('model-size').value = config.model_size;
            document.getElementById('language').value = config.language;
            document.getElementById('translate-check').checked = config.translate_to_english;
            document.getElementById('device-selector').value = config.input_device_index;
            document.getElementById('save-audio-check').checked = config.save_recordings;
            document.getElementById('unload-check').checked = config.unload_model;
            document.getElementById('hotkey-input').value = config.hotkey;
            document.getElementById('api-key').value = config.gemini_api_key;
            document.getElementById('ai-model').value = config.gemini_model;
            
            updateVramEstimate();
        }

        async function saveConfig() {
            const newConfig = {
                model_size: document.getElementById('model-size').value,
                language: document.getElementById('language').value,
                translate_to_english: document.getElementById('translate-check').checked,
                input_device_index: parseInt(document.getElementById('device-selector').value),
                save_recordings: document.getElementById('save-audio-check').checked,
                unload_model: document.getElementById('unload-check').checked,
                hotkey: document.getElementById('hotkey-input').value,
                gemini_api_key: document.getElementById('api-key').value,
                gemini_model: document.getElementById('ai-model').value
            };
            
            await fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(newConfig)
            });
            
            // Flash success (simple visual cue)
            const btn = document.querySelector('button[onclick="saveConfig()"]');
            const originalText = btn.textContent;
            btn.textContent = "Saved!";
            btn.style.background = "var(--success)";
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = "";
            }, 2000);
        }

        async function setupDns() {
            const btn = document.querySelector('button[onclick="setupDns()"]');
            const originalText = btn.textContent;
            btn.textContent = "Setting up...";
            
            try {
                const res = await fetch('/api/action/setup-dns', { method: 'POST' });
                const data = await res.json();
                
                if (data.status === 'success') {
                    alert("Success: " + data.message);
                    btn.style.background = "var(--success)";
                } else {
                    alert("Error: " + data.message);
                    btn.style.background = "var(--danger)";
                }
            } catch (e) {
                alert("Network Error");
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = "";
            }, 2000);
        }

        async function toggleRecording() {
            await fetch('/api/record/toggle', { method: 'POST' });
        }

        async function freeVram() {
            await fetch('/api/action/free-vram', { method: 'POST' });
        }

        async function pollStatus() {
            const res = await fetch('/api/status');
            const status = await res.json();
            updateStatusUI(status);
        }

        // --- UI Logic ---
        function updateStatusUI(status) {
            const badge = document.getElementById('status-badge');
            const text = document.getElementById('status-text');
            const box = document.getElementById('transcription-box');
            const btn = document.getElementById('toggle-btn');
            
            text.textContent = status.status_text || "Ready";
            document.getElementById('last-action').textContent = status.last_action || "-";
            
            if (status.last_transcription && status.last_transcription !== "-") {
                box.textContent = status.last_transcription;
                box.classList.add('active');
            }
            
            if (status.is_recording) {
                badge.classList.add('recording');
                btn.textContent = "Stop Recording";
                btn.classList.add('btn-danger');
                btn.classList.remove('btn-primary');
            } else {
                badge.classList.remove('recording');
                btn.textContent = "Start Recording";
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-primary');
            }
        }

        function updateVramEstimate() {
            const model = document.getElementById('model-size').value;
            const estimate = vramEstimates[model] || 1.0;
            const total = systemInfo.vram_total_gb || 8;
            
            const pct = Math.min((estimate / total) * 100, 100);
            
            document.getElementById('est-vram-bar').style.width = pct + '%';
            document.getElementById('est-vram-text').textContent = `~${estimate} GB / ${total} GB`;
            
            // Color coding
            const bar = document.getElementById('est-vram-bar');
            if (pct > 80) bar.style.background = 'var(--danger)';
            else if (pct > 50) bar.style.background = '#eab308'; // Yellow
            else bar.style.background = 'var(--accent)';
        }

        function applyPreset() {
            const preset = document.getElementById('preset-selector').value;
            const modelSelect = document.getElementById('model-size');
            
            if (preset === 'custom') return;

            if (preset === 'quality') modelSelect.value = 'large-v3';
            if (preset === 'balanced') modelSelect.value = 'distil-large-v3';
            if (preset === 'speed') modelSelect.value = 'large-v3-turbo';
            if (preset === 'low-vram') modelSelect.value = 'distil-small.en';
            
            updateVramEstimate();
        }

        function connectWebsocket() {
            // Basic keepalive connection for future real-time events
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'status') updateStatusUI(data.payload);
            };
            ws.onclose = () => setTimeout(connectWebsocket, 1000);
        }

        // Start
        init();
    </script>
</body>
</html>
